---
title: "Take Home Final"
format:
  html:
    embed-resources: true
code-fold: false
toc: true
---

```{python}
import pandas as pd
from sklearn.model_selection import GridSearchCV
from sklearn.pipeline import Pipeline
from sklearn.preprocessing import StandardScaler
from sklearn.discriminant_analysis import LinearDiscriminantAnalysis
from sklearn.metrics import confusion_matrix, f1_score
import numpy as np
from sklearn.model_selection import cross_val_score
from sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis
from sklearn.svm import SVC
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler, OneHotEncoder, PolynomialFeatures
from sklearn.compose import ColumnTransformer

```

```{python}
import pandas as pd

df = pd.read_csv("CAH-201803-train.csv")
df.dropna(inplace=True)
df
```

```{python}
X = df.drop(columns=['political_affiliation', 'id_num'])
X = X[['Q13', 'Q14', 'Q6', 'Q4', 'Q5', 'Q8', 'Q12']]

y = df['political_affiliation']

df['political_affiliation'].value_counts()
```

## Q1 LDA
```{python}

categorical_cols = X.select_dtypes(include=["object"]).columns
numeric_cols = X.select_dtypes(exclude=["object"]).columns

ct = ColumnTransformer(
    [
        ("dummify", OneHotEncoder(handle_unknown="ignore"), categorical_cols),
        ("num", "passthrough", numeric_cols)
    ]
)

lda_model = Pipeline(
  [("preprossing", ct),
  ("lda", LinearDiscriminantAnalysis())]
)

params_lda = {
    "lda__solver": ['lsqr'],
    "lda__shrinkage": ['auto', None, 0.2, 0.4, 0.6, 0.8, 1]
}

grid_search = GridSearchCV(lda_model, params_lda, cv=5, scoring='accuracy')
grid_search.fit(X, y)

best_model_lda = grid_search.best_estimator_
y_pred_lda = best_model_lda.predict(X)
f1_score_lda = f1_score(y, y_pred_lda, average='weighted')

lda_scores = cross_val_score(best_model_lda, X, y, cv = 5, scoring = 'accuracy')

f1_cv_lda = np.mean(lda_scores)
print(f"Cross Validated f1_macro score (LDA): {f1_cv_lda}")

best_model_lda.fit(X, y)
confusion_matrix(y, y_pred_lda)
# import pandas as pd

# cv_results_df = pd.DataFrame(grid_search.cv_results_)
# cv_results_df

```


## Q2 QDA
```{python}
qda_model = Pipeline(
  [("preprossing", ct),
  ("qda", QuadraticDiscriminantAnalysis())]
)

params_qda = {
    'qda__reg_param': [0.01, 0.1, 0.3, 0.5, 0.7, 0.9],
    'qda__store_covariance': [False, True]
}

grid_search = GridSearchCV(qda_model, params_qda, cv=5, scoring='accuracy')
grid_search.fit(X, y)

best_model_qda = grid_search.best_estimator_
y_pred_qda = best_model_qda.predict(X)
f1_score_qda = f1_score(y, y_pred_qda, average='weighted')

qda_scores = cross_val_score(best_model_qda, X, y, cv = 5, scoring = 'accuracy')

f1_cv_qda = np.mean(qda_scores)
print(f"Cross Validated f1_macro score (QDA): {f1_cv_qda}")

best_model_qda.fit(X, y)
confusion_matrix(y, y_pred_qda)
```

## Q3 SVC
```{python}
svc_model = Pipeline(
  [("preprossing", ct),
  ("svc", SVC(kernel="linear"))]
)

params_svc = {
    "svc__C": [0.1, 1, 10, 100],
}

grid_search = GridSearchCV(svc_model, params_svc, cv=5, scoring='accuracy')
grid_search.fit(X, y)

best_model_svc = grid_search.best_estimator_
y_pred_svc = best_model_svc.predict(X)
f1_score_svc = f1_score(y, y_pred_svc, average='weighted')

svc_scores = cross_val_score(best_model_svc, X, y, cv = 5, scoring = 'accuracy')

f1_cv_svc = np.mean(svc_scores)
print(f"Cross Validated f1_macro score (SVC): {f1_cv_svc}")

best_model_svc.fit(X, y)
confusion_matrix(y, y_pred_svc)
```

## Q4 SVM
```{python}
svm_model = Pipeline(
  [("preprossing", ct),
  ("svc", SVC(kernel="poly"))]
)

params_svm = {
    "svc__C": [0.1, 1, 10, 100],
    "svc__degree": [2, 3, 5, 10],
}

grid_search = GridSearchCV(svm_model, params_svm, cv=5, scoring='accuracy')
grid_search.fit(X, y)

best_model_svm = grid_search.best_estimator_
y_pred_svm = best_model_svm.predict(X)
f1_score_svm = f1_score(y, y_pred_svm, average='weighted')

svm_scores = cross_val_score(best_model_svm, X, y, cv = 5, scoring = 'accuracy')

f1_cv_svm = np.mean(svm_scores)
print(f"Cross Validated f1_macro score (SVM): {f1_cv_svm}")

best_model_svm.fit(X, y)
confusion_matrix(y, y_pred_svm)
```

## Q1 Tree

```{python}
from sklearn.tree import DecisionTreeClassifier

tree_pipeline = Pipeline(
  [("preprossing", ct),
  ("tree", DecisionTreeClassifier())]
)

tree_pipeline

tree_pipeline_fitted = tree_pipeline.fit(X, y)

y_preds_tree = tree_pipeline_fitted.predict(X)

param_grid_tree = {
    "tree__max_depth": [1, 3, 7, 9],
    'tree__min_samples_leaf': [1, 2, 4, 6, 8],
    'tree__criterion': ['gini', 'entropy', 'log_loss']
    }

grid_search = GridSearchCV(tree_pipeline, param_grid_tree, cv=5, scoring='accuracy')
grid_search.fit(X, y)
# tree_df_cv_results_ = pd.DataFrame(tree_grid_search_fitted.cv_results_)

best_model_tree = grid_search.best_estimator_
y_pred_tree = best_model_tree.predict(X)
f1_score_tree = f1_score(y, y_pred_tree, average='weighted')


tree_scores = cross_val_score(best_model_tree, X, y, cv = 5, scoring = 'accuracy')

f1_cv_tree = np.mean(tree_scores)
print(f"Cross Validated f1_macro score (Tree): {f1_cv_tree}")

best_model_tree.fit(X, y)
confusion_matrix(y, y_pred_tree)
y_pred_tree
```


```{python}
best_tree = grid_search.best_estimator_.named_steps['tree']

from sklearn.tree import plot_tree

plot_tree(best_tree)
```

```{python}
X = X[['Q13', 'Q14', 'Q6', 'Q4', 'Q5', 'Q8', 'Q12']]

categorical_cols = X.select_dtypes(include=["object"]).columns
numeric_cols = X.select_dtypes(exclude=["object"]).columns

ct = ColumnTransformer(
    [
        ("dummify", OneHotEncoder(handle_unknown="ignore"), categorical_cols),
        ("num", "passthrough", numeric_cols)
    ]
)

lda_model = Pipeline(
  [("preprossing", ct),
  ("lda", LinearDiscriminantAnalysis())]
)

params_lda = {
    "lda__solver": ['lsqr'],
    "lda__shrinkage": ['auto', None, 0.2, 0.4, 0.6, 0.8, 1]
}

grid_search = GridSearchCV(lda_model, params_lda, cv=5, scoring='accuracy')
grid_search.fit(X, y)

best_model_lda = grid_search.best_estimator_
y_pred_lda = best_model_lda.predict(X)
f1_score_lda = f1_score(y, y_pred_lda, average='weighted')

lda_scores = cross_val_score(best_model_lda, X, y, cv = 5, scoring = 'accuracy')

f1_cv_lda = np.mean(lda_scores)
print(f"Cross Validated f1_macro score (LDA): {f1_cv_lda}")

best_model_lda.fit(X, y)
confusion_matrix(y, y_pred_lda)
```

```{python}
df_test = pd.read_csv("CAH-201803-test.csv")
df_test.dropna(inplace=True)
```

```{python}
X_test = df_test.drop(columns=['id_num'])

test_predictions = best_model_lda.predict(X_test)
df_test["political_affiliation_predicted"] = test_predictions
df_test = df_test[["id_num", "political_affiliation_predicted"]]
df_test
```


```{python}
df_test.to_csv("lda_predictions.csv", index=False)
```


```{python}
# X = X[['Q13', 'Q14', 'Q6', 'Q4', 'Q5', 'Q8', 'Q12']]

```


```{python}
# X = X[['Q13', 'Q14', 'Q6', 'Q4', 'Q5', 'Q8', 'Q12']]

# categorical_cols = X.select_dtypes(include=["object"]).columns
# numeric_cols = X.select_dtypes(exclude=["object"]).columns

# ct = ColumnTransformer(
#     [
#         ("dummify", OneHotEncoder(handle_unknown="ignore"), categorical_cols),
#         ("num", "passthrough", numeric_cols)
#     ]
# )

# qda_model = Pipeline(
#   [("preprossing", ct),
#   ("qda", QuadraticDiscriminantAnalysis())]
# )

# params_qda = {
#     'qda__reg_param': [0.01, 0.1, 0.3, 0.5, 0.7, 0.9, 1],
#     'qda__store_covariance': [False, True]
# }

# grid_search = GridSearchCV(qda_model, params_qda, cv=5, scoring='accuracy')
# grid_search.fit(X, y)

# best_model_qda = grid_search.best_estimator_
# y_pred_qda = best_model_qda.predict(X)
# f1_score_qda = f1_score(y, y_pred_qda, average='weighted')

# qda_scores = cross_val_score(best_model_qda, X, y, cv = 5, scoring = 'accuracy')

# f1_cv_qda = np.mean(qda_scores)
# print(f"Cross Validated f1_macro score (QDA): {f1_cv_qda}")

# best_model_qda.fit(X, y)
# confusion_matrix(y, y_pred_qda)
```

```{python}
# X_test = df_test.drop(columns=['id_num'])

# test_predictions = best_model_qda.predict(X_test)
# df_test["political_affiliation_predicted"] = test_predictions
# df_test = df_test[["id_num", "political_affiliation_predicted"]]
# df_test
```


```{python}
# df_test.to_csv("qda_predictions.csv", index=False)
```